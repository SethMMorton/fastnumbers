language: python
os: linux
dist: xenial

python:
  - 3.5
  - 3.6
  - 3.7
  - 3.8

env:
  - CC=clang
  - CC=gcc CFLAGS="--coverage -O0"

jobs:
  include:
    # Windows tests!
    - {python: 3.5, os: windows, env: PYTHON_VERSION=3.5.4, language: sh}
    - {python: 3.6, os: windows, env: PYTHON_VERSION=3.6.8, language: sh}
    - {python: 3.7, os: windows, env: PYTHON_VERSION=3.7.4, language: sh}
    - {python: 3.8, os: windows, env: PYTHON_VERSION=3.8.0, language: sh}

    # Deployment! This needs to be run once for each major OS,
    # as well as once more to deploy the source distribution.
    - stage: deploy
      name: "Deploy Source Distribution"
      python: 3.6
      install: skip
      before_script: skip
      script: skip
      after_success: skip
      deploy:
        - provider: pypi
          server: https://test.pypi.org/legacy/
          user: SethMMorton
          distributions: sdist --format=gztar
          skip_existing: true
          on:
            tags: false
            repo: SethMMorton/fastnumbers
            branch: master
        - provider: pypi
          user: SethMMorton
          distributions: sdist --format=gztar
          skip_existing: true
          on:
            tags: true
            repo: SethMMorton/fastnumbers
            branch: master
    - stage: deploy
      name: "Build and Deploy Linux Wheels"
      python: 3.6
      services: docker
      before_install: skip
      install: skip
      before_script: skip
      script: bash dev/ci-wheel-deploy.bash
      after_success: skip
    - stage: deploy
      name: "Build and Deploy MacOS Wheels"
      os: osx
      language: sh
      before_install: skip
      install: skip
      before_script: skip
      script: bash dev/ci-wheel-deploy.bash
      after_success: skip
    - stage: deploy
      name: "Build and Deploy Windows Wheels"
      os: windows
      language: sh
      install: skip
      before_script: skip
      script: PYTHON_VERSION=3.6.8 bash dev/ci-wheel-deploy.bash
      after_success: skip

before_install:
- bash dev/ci-install-python.bash
- source dev/ci-update-path.bash

install:
- python -m pip install -U pip
- python -m pip install codecov
- python -m pip install -r dev/requirements.txt

before_script:
- python dev/patch_doctest.py

script:
- python setup.py install
- python -m doctest fastnumbers
- pytest --hypothesis-profile=slow-tests --doctest-glob=README.rst

after_success:
- (test "$CC" == "gcc" && codecov --gcov-args '-o build/temp.*/src') || echo "skipping coverage!"

stages:
- test
- name: deploy
  if: branch = master AND repo = SethMMorton/fastnumbers

cache:
  - pip
  - directories:
    - $HOME/.pyenv_cache
    - /c/Python35
    - /c/Python36
    - /c/Python37
    - /c/Python38
